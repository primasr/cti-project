import os
import time
import logging
import requests
from datetime import datetime
from typing import Optional, Dict
from .config import MALWAREBAZAAR_API_KEY, MALWAREBAZAAR_URL

def malwarebazaar_lookup(file_hash: str, retries: int = 3) -> Optional[Dict]:
    """
    Lookup file hash reputation from MalwareBazaar.
    Supports MD5 / SHA1 / SHA256.
    Returns normalized TIP fields or None.
    """

    if not MALWAREBAZAAR_API_KEY:
        logging.error("MALWAREBAZAAR_API_KEY not set")
        return None

    headers = {
        "Auth-Key": MALWAREBAZAAR_API_KEY,
        "Accept": "application/json",
        "User-Agent": "CTI-TIP/1.0",
    }

    payload = {
        "query": "get_info",
        "hash": file_hash,
    }

    for attempt in range(1, retries + 1):
        try:
            resp = requests.post(
                MALWAREBAZAAR_URL,
                headers=headers,
                data=payload,
                timeout=15,
            )
            resp.raise_for_status()
            raw = resp.json()

            # ðŸš« Hash not found â†’ HARD STOP (no retry)
            if raw.get("query_status") == "hash_not_found":
                logging.info(f"MalwareBazaar hash not found | HASH={file_hash}")
                return None

            data = raw.get("data")
            if not data or not isinstance(data, list):
                logging.warning(f"Malformed MalwareBazaar response | HASH={file_hash}")
                return None

            entry = data[0]
            break

        except requests.RequestException as e:
            logging.warning(
                f"MalwareBazaar attempt {attempt}/{retries} failed | HASH={file_hash} | {e}"
            )
            time.sleep(2 * attempt)

    else:
        logging.error(f"MalwareBazaar lookup failed after retries | HASH={file_hash}")
        return None

    # ---- Normalize timestamps ----
    def normalize_ts(ts: str) -> str:
        if not ts:
            return ""
        try:
            return (
                datetime.fromisoformat(ts)
                .strftime("%Y-%m-%d %H:%M:%S")
            )
        except Exception:
            return ts

    vendor_intel = entry.get("vendor_intel") or {}

    return {
        "malwarebazaar_first_seen": normalize_ts(entry.get("first_seen", "")),
        "malwarebazaar_last_seen": normalize_ts(entry.get("last_seen", "")),
        "malwarebazaar_signature": entry.get("signature", ""),
        "malwarebazaar_vendor_intel_count": len(vendor_intel),
    }
