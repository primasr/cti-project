import requests
import json
from datetime import datetime
import os
from dotenv import load_dotenv
load_dotenv()

from pathlib import Path
BASE_DIR = Path(__file__).resolve().parents[0]

MALWAREBAZAAR_API_KEY = os.getenv("MALWAREBAZAAR_API_KEY")
API_URL = "https://mb-api.abuse.ch/api/v1/"

def check_hash_malwarebazaar(file_hash):
    headers = {
        "Auth-Key": MALWAREBAZAAR_API_KEY,
        "Accept": "application/json"
    }

    data = {
        "query": "get_info",
        "hash": file_hash
    }

    response = requests.post(
        API_URL,
        headers=headers,
        data=data,
        timeout=15
    )

    response.raise_for_status()
    return response.json()

def save_response(data):
    timestamp = datetime.utcnow().strftime("%Y%m%d_%H%M%S")
    filename = f"response_malwarebazaar_file_{timestamp}.json"
    filename = BASE_DIR / filename

    with open(filename, "w") as f:
        json.dump(data, f, indent=4)

    print(f"[+] Response saved to: {filename}")

if __name__ == "__main__":
    file_hash = input("Enter file hash (MD5 / SHA1 / SHA256): ").strip()

    result = check_hash_malwarebazaar(file_hash)
    save_response(result)
